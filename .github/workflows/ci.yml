name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  quality:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, mysql
          coverage: xdebug
          tools: composer

      - name: Cache Composer packages
        uses: actions/cache@v3
        with:
          path: ~/.composer/cache/files
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction --ignore-platform-reqs

      - name: Preview smart cleaning (dry-run)
        run: |
          echo "ğŸ“‹ AperÃ§u du nettoyage intelligent..."
          php scripts/clean-code.php --test

      - name: Run PHP CS Fixer
        run: composer cs-check

      - name: Run PHPStan
        run: composer phpstan -vvv

      - name: Run PHPUnit tests
        run: php bin/phpunit --coverage-text

  # ğŸ¤– AUTOMATISATION COMPLÃˆTE : CrÃ©ation d'une PR de nettoyage
  auto-cleaning:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.PORTFOLIO_TOKEN }}
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml

      - name: Configure Git Bot
        run: |
          git config --local user.email "bot@portfolio.dev"
          git config --local user.name "Portfolio Cleaner Bot"

      - name: Create cleaning branch
        run: |
          timestamp=$(date +%Y%m%d-%H%M%S)
          branch_name="auto-clean-$timestamp"
          git checkout -b "$branch_name"
          echo "BRANCH_NAME=$branch_name" >> $GITHUB_ENV

      - name: Apply smart cleaning
        run: |
          echo "ğŸ§¹ Application du nettoyage intelligent..."
          php scripts/clean-code.php --apply

      - name: Check and commit changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "found=true" >> $GITHUB_OUTPUT
            
            echo "ğŸ“Š RÃ‰SULTATS DU NETTOYAGE :"
            git status --porcelain
            echo ""
            git diff --stat
            
            git add -A
            git commit -m "ğŸ§¹ [Auto-Clean]: Code nettoyÃ© pour la production

            ğŸ“‹ Nettoyage automatique appliquÃ© :
            - âœ… Commentaires TODO, DEBUG, INFO supprimÃ©s
            - âœ… Console.log de debug nettoyÃ©s
            - âœ… Code optimisÃ© pour la production
            - âœ… Branche dev prÃ©servÃ©e intacte
            
            ğŸ¤– GÃ©nÃ©rÃ© automatiquement par GitHub Actions
            ğŸ”— Workflow: ${{ github.run_id }}"
            
            git push origin "$BRANCH_NAME"
            
            echo "âœ… Branche de nettoyage crÃ©Ã©e : $BRANCH_NAME"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "âœ… Code dÃ©jÃ  propre - aucun nettoyage nÃ©cessaire"
          fi

      # ğŸš€ CrÃ©ation automatique de la PR
      - name: Create Cleaning Pull Request
        if: steps.changes.outputs.found == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.PORTFOLIO_TOKEN }}
        run: |
          pr_url=$(gh pr create \
            --title "ğŸ§¹ [Auto-Clean]: Nettoyage automatique du code de production" \
            --body "## ğŸ¤– Nettoyage automatique du code

          Cette PR a Ã©tÃ© **crÃ©Ã©e automatiquement** suite au merge vers main.

          ### ğŸ“‹ Changements appliquÃ©s :
          - ğŸ§¹ **Commentaires de dÃ©veloppement supprimÃ©s** (TODO, DEBUG, INFO, etc.)
          - ğŸš« **Console.log de debug nettoyÃ©s**
          - âš¡ **Code optimisÃ© pour la production**
          - ğŸ›¡ï¸ **Code critique prÃ©servÃ©** (docblocks, attributs PHP, etc.)

          ### ğŸ” VÃ©rifications effectuÃ©es :
          - âœ… Attributs PHP 8 conservÃ©s (#[Route(...)])
          - âœ… Docblocks de documentation prÃ©servÃ©s  
          - âœ… Commentaires de configuration maintenus
          - âœ… Seuls les vrais commentaires de debug supprimÃ©s

          ### ğŸ¯ Workflow automatisÃ© :
          1. âœ… **Branche dev** â†’ Commentaires prÃ©servÃ©s pour le dÃ©veloppement
          2. âœ… **Merge vers main** â†’ DÃ©clenchement automatique du nettoyage
          3. âœ… **PR automatique** â†’ Code nettoyÃ© prÃªt pour la production
          4. âœ… **Merge de cette PR** â†’ Code de production optimisÃ©

          ### â„¹ï¸ Instructions :
          - ğŸ‘€ **Reviewez** les changements ci-dessous
          - âœ… **Mergez cette PR** pour appliquer le nettoyage  
          - ğŸ‰ **C'est tout !** Votre code sera automatiquement propre en production

          ---
          ğŸ¤– **Automatisation Portfolio - GitHub Actions**  
          ğŸ”— **Workflow ID:** \`${{ github.run_id }}\`  
          ğŸ“… **GÃ©nÃ©rÃ© le :** \`$(date)\`" \
            --head "$BRANCH_NAME" \
            --base main \
            --label "ğŸ¤– automated" \
            --label "ğŸ§¹ cleaning" \
            --label "ğŸš€ production")
          
          echo "ğŸ‰ PR de nettoyage crÃ©Ã©e automatiquement !"
          echo "ğŸ”— URL: $pr_url"
          echo ""
          echo "âœ… AUTOMATISATION TERMINÃ‰E"
          echo "ğŸ‘€ VÃ©rifiez et mergez la PR pour finaliser le nettoyage"

      # ğŸ“Š RÃ©sumÃ© de l'autom