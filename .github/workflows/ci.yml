name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  quality:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, mysql
          coverage: xdebug
          tools: composer

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Composer packages
        uses: actions/cache@v3
        with:
          path: ~/.composer/cache/files
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - name: Install PHP dependencies
        run: composer install --prefer-dist --no-progress --no-interaction --ignore-platform-reqs

      - name: Install Node.js dependencies
        run: npm install

      - name: Preview smart cleaning (dry-run)
        run: |
          echo "ğŸ“‹ AperÃ§u du nettoyage intelligent..."
          php scripts/clean-code.php --test

      - name: Run PHP CS Fixer
        run: composer cs-check

      - name: Run PHPStan
        run: composer phpstan -vvv

      - name: Run PHPUnit tests
        run: php bin/phpunit --coverage-text

      - name: Verify JavaScript syntax before processing
        run: |
          echo "ğŸ” VÃ©rification de la syntaxe JavaScript initiale..."
          npx eslint assets/js/**/*.js || echo "âš ï¸ Erreurs de syntaxe dÃ©tectÃ©es - peuvent Ãªtre corrigÃ©es par le nettoyage"


  auto-cleaning:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.PORTFOLIO_TOKEN }}
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml

      - name: Setup Node.js with tools
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install JavaScript tools
        run: |
          npm install -g prettier@3.1.0 eslint@8.57.0
          echo "ğŸ“¦ Outils installÃ©s:"
          echo "   - Prettier: $(prettier --version)"
          echo "   - ESLint: $(eslint --version)"

      - name: Configure Git Bot
        run: |
          git config --local user.email "bot@portfolio.dev"
          git config --local user.name "Portfolio Cleaner Bot"

      - name: Create cleaning branch
        run: |
          timestamp=$(date +%Y%m%d-%H%M%S)
          branch_name="auto-clean-$timestamp"
          git checkout -b "$branch_name"
          echo "BRANCH_NAME=$branch_name" >> $GITHUB_ENV

      - name: Apply smart cleaning
        run: |
          echo "ğŸ§¹ Application du nettoyage intelligent..."
          php scripts/clean-code.php --apply

      - name: Format JavaScript with Prettier
        run: |
          echo "ğŸ¨ Formatage du JavaScript avec Prettier..."
          
          # Configuration Prettier pour votre projet
          cat > .prettierrc << EOF
          {
            "semi": true,
            "trailingComma": "es5",
            "singleQuote": true,
            "tabWidth": 4,
            "useTabs": false,
            "printWidth": 100,
            "bracketSpacing": true,
            "arrowParens": "avoid"
          }
          EOF
          
          # Appliquer Prettier sur tous les fichiers JS
          find assets/js -name "*.js" -type f -exec prettier --write {} +
          
          echo "âœ… Formatage JavaScript terminÃ©"

      - name: Verify JavaScript syntax
        id: js_check
        run: |
          echo "ğŸ” VÃ©rification de la syntaxe JavaScript..."
          
          # VÃ©rifier tous les fichiers JS avec ESLint
          js_errors=0
          if ! npx eslint assets/js/**/*.js; then
            js_errors=1
            echo "âŒ Erreurs ESLint dÃ©tectÃ©es"
          fi
          
          if [ $js_errors -eq 0 ]; then
            echo "âœ… Tous les fichiers JavaScript respectent les rÃ¨gles ESLint"
            echo "js_valid=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Fichiers JavaScript avec des erreurs ESLint"
            echo "js_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Check and commit changes
        id: changes
        if: steps.js_check.outputs.js_valid == 'true'
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "found=true" >> $GITHUB_OUTPUT
            
            echo "ğŸ“Š RÃ‰SULTATS DU NETTOYAGE :"
            git status --porcelain
            echo ""
            echo "ğŸ“ˆ Statistiques des changements :"
            git diff --stat
            echo ""
            echo "ğŸ¯ Fichiers JavaScript formatÃ©s :"
            git diff --name-only | grep -E '\.js$' | wc -l | xargs echo "   Fichiers JS modifiÃ©s:"
            
            git add -A
            git commit -m "ğŸ§¹ [Auto-Clean]: Code nettoyÃ© et formatÃ© pour la production

            ğŸ“‹ Nettoyage automatique appliquÃ© :
            - âœ… Commentaires TODO, DEBUG, INFO supprimÃ©s
            - âœ… Console.log de debug nettoyÃ©s  
            - âœ… Code formatÃ© avec Prettier
            - âœ… Syntaxe JavaScript vÃ©rifiÃ©e avec ESLint
            - âœ… Branche dev prÃ©servÃ©e intacte
            
            ğŸ› ï¸ Outils utilisÃ©s :
            - Smart Code Cleaner v2.3
            - Prettier $(prettier --version)
            - ESLint $(eslint --version)
            
            ğŸ¤– GÃ©nÃ©rÃ© automatiquement par GitHub Actions
            ğŸ”— Workflow: ${{ github.run_id }}"
            
            git push origin "$BRANCH_NAME"
            
            echo "âœ… Branche de nettoyage crÃ©Ã©e : $BRANCH_NAME"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "âœ… Code dÃ©jÃ  propre - aucun nettoyage nÃ©cessaire"
          fi

      - name: Handle JavaScript syntax errors
        if: steps.js_check.outputs.js_valid == 'false'
        run: |
          echo "âŒ ERREUR : Le nettoyage a gÃ©nÃ©rÃ© des erreurs ESLint JavaScript"
          echo ""
          echo "ğŸ”§ Actions recommandÃ©es :"
          echo "   1. VÃ©rifiez les patterns de nettoyage dans clean-code.php"
          echo "   2. Testez le nettoyage en local avec: php scripts/clean-code.php --test"
          echo "   3. Corrigez les patterns problÃ©matiques ou ajustez .eslintrc.json"
          echo ""
          echo "ğŸ›¡ï¸ SÃ©curitÃ© : Aucune PR ne sera crÃ©Ã©e avec du code JavaScript invalide"
          exit 1

      - name: Create Cleaning Pull Request
        if: steps.changes.outputs.found == 'true' && steps.js_check.outputs.js_valid == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.PORTFOLIO_TOKEN }}
        run: |
          pr_url=$(gh pr create \
            --title "ğŸ§¹ [Auto-Clean]: Nettoyage et formatage automatique du code" \
            --body "## ğŸ¤– Nettoyage automatique du code

          Cette PR a Ã©tÃ© **crÃ©Ã©e automatiquement** suite au merge vers main.

          ### ğŸ“‹ Changements appliquÃ©s :
          - ğŸ§¹ **Commentaires de dÃ©veloppement supprimÃ©s** (TODO, DEBUG, INFO, etc.)
          - ğŸš« **Console.log de debug nettoyÃ©s**
          - ğŸ¨ **Code JavaScript formatÃ© avec Prettier**
          - ğŸ” **Syntaxe JavaScript vÃ©rifiÃ©e avec ESLint**
          - âš¡ **Code optimisÃ© pour la production**

          ### ğŸ› ï¸ Outils utilisÃ©s :
          - **Smart Code Cleaner v2.3** - Suppression intelligente des commentaires
          - **Prettier $(prettier --version)** - Formatage automatique du JavaScript  
          - **ESLint $(eslint --version)** - Validation de la syntaxe JavaScript

          ### ğŸ” VÃ©rifications effectuÃ©es :
          - âœ… Attributs PHP 8 conservÃ©s (#[Route(...)])
          - âœ… Docblocks de documentation prÃ©servÃ©s  
          - âœ… Commentaires de configuration maintenus
          - âœ… Syntaxe JavaScript validÃ©e (0 erreur ESLint)
          - âœ… Code formatÃ© selon les standards Prettier

          ### ğŸ¯ Workflow automatisÃ© :
          1. âœ… **Branche dev** â†’ Commentaires prÃ©servÃ©s pour le dÃ©veloppement
          2. âœ… **Merge vers main** â†’ DÃ©clenchement automatique du nettoyage
          3. âœ… **Nettoyage intelligent** â†’ Suppression des commentaires de debug
          4. âœ… **Formatage Prettier** â†’ Code JavaScript propre et cohÃ©rent
          5. âœ… **Validation ESLint** â†’ Syntaxe JavaScript garantie
          6. âœ… **PR automatique** â†’ Code prÃªt pour la production

          ### â„¹ï¸ Instructions :
          - ğŸ‘€ **Reviewez** les changements ci-dessous
          - âœ… **Mergez cette PR** pour appliquer le nettoyage  
          - ğŸ‰ **C'est tout !** Votre code sera automatiquement propre et formatÃ©

          ---
          ğŸ¤– **Automatisation Portfolio - GitHub Actions**  
          ğŸ”— **Workflow ID:** \`${{ github.run_id }}\`  
          ğŸ“… **GÃ©nÃ©rÃ© le :** \`$(date)\`
          ğŸ› ï¸ **Prettier Config:** Semi: true, Single quotes, 4 spaces, 100 chars" \
            --head "$BRANCH_NAME" \
            --base main)

          
          echo "ğŸ‰ PR de nettoyage crÃ©Ã©e automatiquement avec code JavaScript valide !"
          echo "ğŸ”— URL: $pr_url"
          echo ""
          echo "âœ… AUTOMATISATION TERMINÃ‰E"
          echo "ğŸ‘€ VÃ©rifiez et mergez la PR pour finaliser le nettoyage"

      - name: Automation Summary
        if: always()
        run: |
          echo "ğŸ¯ RÃ‰SUMÃ‰ DE L'AUTOMATISATION v2.0"
          echo "=================================="
          echo ""
          if [[ "${{ steps.js_check.outputs.js_valid }}" == "true" && "${{ steps.changes.outputs.found }}" == "true" ]]; then
            echo "âœ… Code nettoyÃ© et formatÃ© automatiquement"
            echo "âœ… Syntaxe JavaScript validÃ©e (0 erreur ESLint)"
            echo "ğŸ”„ PR crÃ©Ã©e pour review et merge final"
            echo "ğŸ¯ Action requise: Mergez la PR de nettoyage"
          elif [[ "${{ steps.js_check.outputs.js_valid }}" == "false" ]]; then
            echo "âŒ Erreurs ESLint JavaScript dÃ©tectÃ©es"
            echo "ğŸ›¡ï¸ PR bloquÃ©e pour protÃ©ger la production"
            echo "ğŸ¯ Action requise: Corriger les patterns de nettoyage ou ajuster ESLint"
          elif [[ "${{ steps.changes.outputs.found }}" == "false" ]]; then
            echo "âœ… Code dÃ©jÃ  propre et formatÃ©"
            echo "ğŸ¯ Aucune action requise"
          fi
          echo ""
          echo "ğŸ›¡ï¸ SÃ©curitÃ©s actives:"
          echo "   â€¢ Dev branch intacte avec tous les commentaires"
          echo "   â€¢ Code critique prÃ©servÃ©"  
          echo "   â€¢ Syntaxe JavaScript garantie"
          echo "   â€¢ Formatage automatique cohÃ©rent"
          echo "   â€¢ Review possible avant application"
          echo ""
          echo "ğŸ¤– Automatisation: ACTIVE âœ…"
          echo "ğŸ¨ Formatage automatique: ACTIVE âœ…"
          echo "ğŸ” Validation ESLint: ACTIVE âœ…"